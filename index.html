<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¨å¢ƒé›»å•†å®šåƒ¹è©¦ç®—å™¨ (å…·å‚™è‡ªå‹•è¨˜æ†¶åŠŸèƒ½)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .input-group {
            position: relative;
        }
        .input-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.25rem;
        }
        .input-field {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 10px 12px;
            width: 100%;
            transition: all 0.2s;
            background-color: #f8fafc;
            color: #1e293b;
        }
        .input-field:focus {
            outline: none;
            border-color: #1e3a8a;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        /* Mode Switcher Styles */
        .mode-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            font-size: 0.875rem;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .mode-btn.active {
            background-color: #1e3a8a;
            color: white;
            box-shadow: 0 2px 4px rgba(30, 58, 138, 0.3);
        }
        .mode-btn.inactive {
            color: #64748b;
            background-color: transparent;
        }
        .mode-btn.inactive:hover {
            background-color: #f1f5f9;
        }
        
        details > summary {
            list-style: none;
            cursor: pointer;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        .hidden-anim {
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .show-anim {
            display: block;
            opacity: 1;
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex items-center justify-center p-4">

    <div class="max-w-5xl w-full grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- å·¦å´ï¼šåƒæ•¸è¨­å®š (ä½” 4 ç­‰ä»½) -->
        <div class="col-span-1 lg:col-span-4 space-y-4">
            
            <!-- æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
            <div class="card p-1.5 flex bg-white sticky top-0 z-10">
                <div id="btnPhysical" class="mode-btn active" onclick="setMode('physical')">
                    ğŸ“¦ å¯¦é«”å•†å“
                </div>
                <div id="btnVirtual" class="mode-btn inactive" onclick="setMode('virtual')">
                    â˜ï¸ è™›æ“¬å•†å“
                </div>
            </div>

            <!-- å€å¡Š 1ï¼šæˆæœ¬è¨­å®š (é è¨­é–‹å•Ÿ) -->
            <details class="card" open>
                <summary class="p-4 flex items-center justify-between font-bold text-slate-800 border-b border-slate-100 hover:bg-slate-50 rounded-t-xl transition-colors">
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-5 bg-blue-900 rounded-full"></span>
                        é€²è²¨æˆæœ¬è¨­å®š
                    </div>
                    <svg class="w-5 h-5 text-slate-400 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </summary>
                <div class="p-5 space-y-4">
                    <div class="input-group">
                        <label class="input-label">äººæ°‘å¹£åŒ¯ç‡</label>
                        <input type="number" id="exchangeRate" value="4.5" step="0.01" class="input-field" oninput="calculate()">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="input-group">
                            <label class="input-label">å•†å“å–®åƒ¹ (RMB)</label>
                            <input type="number" id="costRMB" value="100" class="input-field" oninput="calculate()">
                        </div>
                        <div class="input-group" id="shippingGroup">
                            <label class="input-label">å–®ä»¶é‹è²» (RMB)</label>
                            <input type="number" id="shippingRMB" value="9" class="input-field" oninput="calculate()">
                        </div>
                    </div>
                    
                    <!-- è™›æ“¬å•†å“æç¤º (åˆ‡æ›æ™‚é¡¯ç¤º) -->
                    <div id="virtualHint" class="hidden text-xs text-slate-400 text-center py-2 bg-slate-50 rounded">
                        * è™›æ“¬å•†å“æ¨¡å¼ï¼šå·²è‡ªå‹•å¿½ç•¥é‹è²»æˆæœ¬
                    </div>

                    <div class="p-3 bg-blue-50 rounded text-xs text-blue-800">
                        <div class="flex justify-between font-bold">
                            <span>é ä¼°å°å¹£æˆæœ¬ï¼š</span>
                            <span id="costTWDPreview">NT$ 491</span>
                        </div>
                    </div>
                </div>
            </details>

            <!-- å€å¡Š 2ï¼šåˆ©æ½¤èˆ‡å¹³å°è¨­å®š -->
            <details class="card" open>
                <summary class="p-4 flex items-center justify-between font-bold text-slate-800 border-b border-slate-100 hover:bg-slate-50 rounded-t-xl transition-colors">
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-5 bg-emerald-600 rounded-full"></span>
                        å¹³å°èˆ‡åˆ©æ½¤
                    </div>
                    <svg class="w-5 h-5 text-slate-400 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </summary>
                <div class="p-5 space-y-4">
                    <div class="input-group">
                        <label class="input-label flex justify-between">
                            è¦çš®æ‰‹çºŒè²»æŠ½æˆ
                            <span class="text-xs text-slate-400">% ä½”å”®åƒ¹</span>
                        </label>
                        <div class="relative">
                            <input type="number" id="platformFeePercent" value="15" class="input-field pr-8" oninput="calculate()">
                            <span class="absolute right-3 top-2.5 text-slate-400">%</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label flex justify-between">
                            ç™¼ç¥¨/ç¨…é‡‘
                            <span class="text-xs text-slate-400">% ä½”å”®åƒ¹</span>
                        </label>
                        <div class="relative">
                            <input type="number" id="taxPercent" value="5" class="input-field pr-8" oninput="calculate()">
                            <span class="absolute right-3 top-2.5 text-slate-400">%</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label flex justify-between text-blue-800 font-bold">
                            ç›®æ¨™æ·¨åˆ©æ½¤ç‡
                            <span class="text-xs text-blue-300">% ä½”å”®åƒ¹</span>
                        </label>
                        <div class="relative">
                            <input type="number" id="profitPercent" value="15" class="input-field pr-8 border-blue-200 bg-blue-50" oninput="calculate()">
                            <span class="absolute right-3 top-2.5 text-blue-400">%</span>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <!-- å³å´ï¼šè¨ˆç®—çµæœ (ä½” 8 ç­‰ä»½) -->
        <div class="col-span-1 lg:col-span-8 space-y-6">
            
            <!-- æ ¸å¿ƒçµæœå¡ç‰‡ -->
            <div class="card bg-slate-800 text-white p-6 md:p-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div>
                        <h2 class="text-slate-300 text-sm font-medium mb-1">å»ºè­°è²©å”®åƒ¹æ ¼ (å°å¹£)</h2>
                        <div class="flex items-baseline gap-2">
                            <span class="text-5xl font-bold tracking-tight text-white" id="finalPrice">0</span>
                            <span class="text-lg text-slate-400">TWD</span>
                        </div>
                    </div>
                    <div class="mt-4 md:mt-0 text-right">
                        <div class="text-emerald-400 font-bold text-xl">+ NT$ <span id="profitAmount">0</span></div>
                        <div class="text-slate-400 text-sm">å–®ä»¶æ·¨åˆ©</div>
                    </div>
                </div>

                <!-- ç°¡æ˜“é€²åº¦æ¢è¦–è¦ºåŒ– -->
                <div class="w-full h-3 bg-slate-700 rounded-full overflow-hidden flex">
                    <div id="barCost" class="h-full bg-slate-500" style="width: 50%"></div>
                    <div id="barFee" class="h-full bg-orange-400" style="width: 25%"></div>
                    <div id="barProfit" class="h-full bg-emerald-500" style="width: 25%"></div>
                </div>
                <div class="flex justify-between text-xs text-slate-400 mt-2">
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-slate-500"></div> æˆæœ¬</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-orange-400"></div> å¹³å°+ç¨…</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500"></div> æ·¨åˆ©</div>
                </div>
            </div>

            <!-- è©³ç´°æç›Šè¡¨ -->
            <div class="card p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-900" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    è©³ç´°æç›Šåˆ†æ
                </h3>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                            <tr>
                                <th class="px-4 py-3">é …ç›®</th>
                                <th class="px-4 py-3">è¨ˆç®—æ–¹å¼</th>
                                <th class="px-4 py-3 text-right">é‡‘é¡ (TWD)</th>
                                <th class="px-4 py-3 text-right">ä½”æ¯”</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <!-- æ”¶å…¥ -->
                            <tr class="font-bold bg-blue-50/50">
                                <td class="px-4 py-3 text-blue-900">å•†å“å”®åƒ¹</td>
                                <td class="px-4 py-3 text-slate-500">-</td>
                                <td class="px-4 py-3 text-right text-blue-900" id="tablePrice">0</td>
                                <td class="px-4 py-3 text-right text-slate-500">100%</td>
                            </tr>
                            
                            <!-- æˆæœ¬ -->
                            <tr>
                                <td class="px-4 py-3 text-slate-700">å•†å“æˆæœ¬</td>
                                <td class="px-4 py-3 text-slate-400 text-xs">RMB <span id="tCostRMB">100</span> x åŒ¯ç‡</td>
                                <td class="px-4 py-3 text-right text-red-600" id="tableItemCost">0</td>
                                <td class="px-4 py-3 text-right text-slate-400" id="pctItemCost">--</td>
                            </tr>
                            <!-- é‹è²»è¡Œ (è™›æ“¬å•†å“æœƒéš±è—æˆ–é¡¯ç¤º0) -->
                            <tr id="tableRowShip">
                                <td class="px-4 py-3 text-slate-700">é‹è²»æˆæœ¬</td>
                                <td class="px-4 py-3 text-slate-400 text-xs">RMB <span id="tShipRMB">9</span> x åŒ¯ç‡</td>
                                <td class="px-4 py-3 text-right text-red-600" id="tableShipCost">0</td>
                                <td class="px-4 py-3 text-right text-slate-400" id="pctShipCost">--</td>
                            </tr>
                            
                            <!-- è²»ç”¨ -->
                            <tr>
                                <td class="px-4 py-3 text-slate-700">è¦çš®æ‰‹çºŒè²»</td>
                                <td class="px-4 py-3 text-slate-400 text-xs">å”®åƒ¹ x <span id="tPlatformPct">15</span>%</td>
                                <td class="px-4 py-3 text-right text-orange-600" id="tablePlatformFee">0</td>
                                <td class="px-4 py-3 text-right text-slate-400" id="pctPlatformFee">15%</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 text-slate-700">ç™¼ç¥¨ç¨…é‡‘</td>
                                <td class="px-4 py-3 text-slate-400 text-xs">å”®åƒ¹ x <span id="tTaxPct">5</span>%</td>
                                <td class="px-4 py-3 text-right text-orange-600" id="tableTaxFee">0</td>
                                <td class="px-4 py-3 text-right text-slate-400" id="pctTaxFee">5%</td>
                            </tr>

                            <!-- åˆ©æ½¤ -->
                            <tr class="font-bold bg-emerald-50">
                                <td class="px-4 py-3 text-emerald-800">æ·¨åˆ©æ½¤</td>
                                <td class="px-4 py-3 text-emerald-600 text-xs">å”®åƒ¹ - ç¸½æ”¯å‡º</td>
                                <td class="px-4 py-3 text-right text-emerald-600" id="tableProfit">0</td>
                                <td class="px-4 py-3 text-right text-emerald-600" id="pctProfit">15%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 p-4 bg-slate-100 rounded text-xs text-slate-500 leading-relaxed">
                    <strong>ğŸ’¡ è¨ˆç®—å…¬å¼èªªæ˜ï¼š</strong><br>
                    æ­¤è¨ˆç®—æ©Ÿä½¿ç”¨ã€Œåˆ©æ½¤ç‡å›æ¨æ³•ã€ï¼Œç¢ºä¿æ‚¨çš„åˆ©æ½¤æ˜¯ä½”ã€Œæœ€çµ‚å”®åƒ¹ã€çš„ 15%ã€‚<br>
                    å…¬å¼ï¼š<code>å”®åƒ¹ = (å•†å“æˆæœ¬ + é‹è²»æˆæœ¬) / (1 - (æ‰‹çºŒè²»% + ç¨…é‡‘% + åˆ©æ½¤%))</code>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'physical'; // physical or virtual

        // å„²å­˜è¨­å®šåˆ° LocalStorage
        function saveToLocal() {
            const data = {
                mode: currentMode,
                exchangeRate: document.getElementById('exchangeRate').value,
                costRMB: document.getElementById('costRMB').value,
                shippingRMB: document.getElementById('shippingRMB').value,
                platformFeePercent: document.getElementById('platformFeePercent').value,
                taxPercent: document.getElementById('taxPercent').value,
                profitPercent: document.getElementById('profitPercent').value
            };
            localStorage.setItem('shopeeCalcData_v2', JSON.stringify(data));
        }

        // å¾ LocalStorage è®€å–è¨­å®š
        function loadFromLocal() {
            const saved = localStorage.getItem('shopeeCalcData_v2');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    document.getElementById('exchangeRate').value = data.exchangeRate || 4.5;
                    document.getElementById('costRMB').value = data.costRMB || 100;
                    document.getElementById('shippingRMB').value = data.shippingRMB || 9;
                    document.getElementById('platformFeePercent').value = data.platformFeePercent || 15;
                    document.getElementById('taxPercent').value = data.taxPercent || 5;
                    document.getElementById('profitPercent').value = data.profitPercent || 15;
                    
                    if (data.mode) {
                        setMode(data.mode, false); // false = ä¸è¦å†æ¬¡é‡è¤‡è¨ˆç®—ï¼Œç¨å¾Œçµ±ä¸€ç®—
                    }
                } catch (e) {
                    console.error("è®€å–å„²å­˜è³‡æ–™å¤±æ•—", e);
                }
            }
            calculate();
        }

        function setMode(mode, doCalculate = true) {
            currentMode = mode;
            
            const btnPhys = document.getElementById('btnPhysical');
            const btnVirt = document.getElementById('btnVirtual');
            const shipGroup = document.getElementById('shippingGroup');
            const rowShip = document.getElementById('tableRowShip');
            const virtHint = document.getElementById('virtualHint');

            if (mode === 'physical') {
                btnPhys.className = 'mode-btn active';
                btnVirt.className = 'mode-btn inactive';
                shipGroup.style.display = 'block';
                rowShip.style.display = 'table-row';
                virtHint.classList.add('hidden');
            } else {
                btnPhys.className = 'mode-btn inactive';
                btnVirt.className = 'mode-btn active';
                shipGroup.style.display = 'none';
                rowShip.style.display = 'none';
                virtHint.classList.remove('hidden');
            }
            if (doCalculate) calculate();
        }

        // æ ¼å¼åŒ–æ•¸å­— (åƒåˆ†ä½)
        function formatMoney(num) {
            return num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function calculate() {
            // 1. ç²å–è¼¸å…¥
            const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 0;
            const costRMB = parseFloat(document.getElementById('costRMB').value) || 0;
            
            // æ ¹æ“šæ¨¡å¼æ±ºå®šé‹è²»
            let shippingRMB = 0;
            if (currentMode === 'physical') {
                shippingRMB = parseFloat(document.getElementById('shippingRMB').value) || 0;
            } else {
                shippingRMB = 0;
            }
            
            const platformFeePct = parseFloat(document.getElementById('platformFeePercent').value) || 0;
            const taxPct = parseFloat(document.getElementById('taxPercent').value) || 0;
            const profitPct = parseFloat(document.getElementById('profitPercent').value) || 0;

            // 2. è¨ˆç®—åŸºç¤æˆæœ¬ (TWD)
            const itemCostTWD = costRMB * exchangeRate;
            const shippingCostTWD = shippingRMB * exchangeRate;
            const totalCostTWD = itemCostTWD + shippingCostTWD;

            // é è¦½å°è¨ˆ
            document.getElementById('costTWDPreview').innerText = "NT$ " + formatMoney(totalCostTWD);

            // 3. è¨ˆç®—ç›®æ¨™å”®åƒ¹
            // å…¬å¼ï¼šå”®åƒ¹ = æˆæœ¬ / (1 - æ‰€æœ‰ç™¾åˆ†æ¯”ç¸½å’Œ)
            const totalDeductionRate = (platformFeePct + taxPct + profitPct) / 100;
            
            let finalPrice = 0;
            if (totalDeductionRate < 1) {
                finalPrice = totalCostTWD / (1 - totalDeductionRate);
            } else {
                finalPrice = 0; 
            }

            // 4. è¨ˆç®—å„é …é‡‘é¡
            const platformFee = finalPrice * (platformFeePct / 100);
            const taxFee = finalPrice * (taxPct / 100);
            const profitAmount = finalPrice * (profitPct / 100); 
            
            // 5. æ›´æ–° UI - å¤§æ•¸å­—
            document.getElementById('finalPrice').innerText = formatMoney(finalPrice);
            document.getElementById('profitAmount').innerText = formatMoney(profitAmount);

            // 6. æ›´æ–° UI - è¡¨æ ¼æ•¸å€¼
            document.getElementById('tablePrice').innerText = formatMoney(finalPrice);
            
            document.getElementById('tCostRMB').innerText = costRMB;
            document.getElementById('tableItemCost').innerText = "-" + formatMoney(itemCostTWD);
            document.getElementById('pctItemCost').innerText = ((itemCostTWD / finalPrice) * 100).toFixed(1) + "%";

            // é‹è²»è¡¨æ ¼åˆ—
            document.getElementById('tShipRMB').innerText = shippingRMB;
            document.getElementById('tableShipCost').innerText = "-" + formatMoney(shippingCostTWD);
            if (finalPrice > 0) {
                 document.getElementById('pctShipCost').innerText = ((shippingCostTWD / finalPrice) * 100).toFixed(1) + "%";
            } else {
                 document.getElementById('pctShipCost').innerText = "0%";
            }
           

            document.getElementById('tPlatformPct').innerText = platformFeePct;
            document.getElementById('tablePlatformFee').innerText = "-" + formatMoney(platformFee);
            document.getElementById('pctPlatformFee').innerText = platformFeePct + "%";

            document.getElementById('tTaxPct').innerText = taxPct;
            document.getElementById('tableTaxFee').innerText = "-" + formatMoney(taxFee);
            document.getElementById('pctTaxFee').innerText = taxPct + "%";

            document.getElementById('tableProfit').innerText = formatMoney(profitAmount);
            document.getElementById('pctProfit').innerText = profitPct + "%";

            // 7. æ›´æ–°é€²åº¦æ¢å¯¬åº¦
            const totalCostPct = ((totalCostTWD / finalPrice) * 100);
            const feeAndTaxPct = platformFeePct + taxPct;
            
            document.getElementById('barCost').style.width = totalCostPct + "%";
            document.getElementById('barFee').style.width = feeAndTaxPct + "%";
            document.getElementById('barProfit').style.width = profitPct + "%";

            // 8. æ¯æ¬¡è¨ˆç®—å®Œéƒ½å„²å­˜
            saveToLocal();
        }

        // åˆå§‹åŒ–ï¼šå…ˆè®€å–å­˜æª”ï¼Œå†è¨ˆç®—
        loadFromLocal();
        
        // ç›£è½ Details å±•é–‹è¡Œç‚º (é¸ç”¨ UI å¢å¼·)
        document.querySelectorAll("details").forEach((detail) => {
            detail.addEventListener("toggle", (e) => {
                const icon = detail.querySelector("svg");
                if (detail.open) {
                    icon.style.transform = "rotate(180deg)";
                } else {
                    icon.style.transform = "rotate(0deg)";
                }
            });
        });
    </script>
</body>
</html>
